{% extends 'industry_base.html' %}
{% set active = 'profile' %}
{% set title = 'Profile & Settings - BlueCarbon' %}
{% set header = 'Profile & Settings' %}
{% set subheader = 'Manage your company information and compliance documents' %}

{% block header_actions %}
<div style="display: flex; gap: 0.75rem; align-items: center;">
    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: {{ '#f0fdf4' if company.verification_status == 'Verified' else '#fffbeb' }}; border-radius: 8px; border: 1px solid {{ '#dcfce7' if company.verification_status == 'Verified' else '#fde68a' }};">
        <i class="fas fa-{{ 'check-circle' if company.verification_status == 'Verified' else 'clock' }}" style="color: {{ 'var(--success)' if company.verification_status == 'Verified' else 'var(--warning)' }};"></i>
        <span style="font-size: 0.875rem; color: {{ '#166534' if company.verification_status == 'Verified' else '#92400e' }};">{{ company.verification_status }}</span>
    </div>
    <button class="btn btn-primary" onclick="saveProfile()">
        <i class="fas fa-save"></i>
        Save Changes
    </button>
</div>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Left Column - Profile Information -->
    <div>
        <!-- Company Details -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h3><i class="fas fa-building"></i> Company Details</h3>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" value="{{ company.company_name }}" readonly>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Contact support to change company name
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Industry Type</label>
                            <select class="form-control" id="industryType">
                                <option value="Manufacturing" {{ 'selected' if company.industry_type == 'Manufacturing' }}>Manufacturing</option>
                                <option value="Technology" {{ 'selected' if company.industry_type == 'Technology' }}>Technology</option>
                                <option value="Energy" {{ 'selected' if company.industry_type == 'Energy' }}>Energy</option>
                                <option value="Transportation" {{ 'selected' if company.industry_type == 'Transportation' }}>Transportation</option>
                                <option value="Agriculture" {{ 'selected' if company.industry_type == 'Agriculture' }}>Agriculture</option>
                                <option value="Other" {{ 'selected' if company.industry_type == 'Other' }}>Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Company Address</label>
                        <textarea class="form-control" rows="3" id="address">{{ company.address }}</textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contactPerson" value="{{ company.contact_person }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" value="{{ company.email }}">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" value="{{ company.phone }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Annual Emissions (tCO₂e)</label>
                            <input type="number" class="form-control" id="annualEmissions" value="{{ company.annual_emissions }}" min="0" step="0.1">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Used for carbon footprint calculations
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Financial Information -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h3><i class="fas fa-university"></i> Financial Information</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Digital Wallet Address</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-control" id="walletAddress" value="{{ company.wallet_address }}" readonly style="font-family: monospace; font-size: 0.875rem;">
                            <button type="button" class="btn btn-outline" onclick="copyToClipboard('walletAddress')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Preferred Payment Method</label>
                        <select class="form-control" id="paymentMethod">
                            <option value="wallet">Digital Wallet</option>
                            <option value="upi">UPI</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Bank Account Details (Optional)</label>
                    <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                            Bank account information is encrypted and used only for transaction verification.
                        </div>
                        <button type="button" class="btn btn-outline" onclick="manageBankDetails()">
                            <i class="fas fa-university"></i>
                            Manage Bank Details
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compliance Documents -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-file-alt"></i> Compliance Documents</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 2rem;">
                    <div style="padding: 1rem; background: #fffbeb; border-radius: 8px; border-left: 4px solid var(--warning); margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: var(--warning);"></i>
                            <strong>Document Requirements</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                            Upload the following documents for verification and compliance purposes. All documents should be current and in PDF format.
                        </p>
                    </div>
                    
                    <!-- Document Upload Areas -->
                    <div style="display: grid; gap: 1rem;">
                        <!-- Company Registration -->
                        <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 2rem; text-align: center; transition: border-color 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                            <div style="margin-bottom: 1rem;">
                                <i class="fas fa-building" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                                <h4 style="margin: 0; color: var(--dark);">Company Registration Certificate</h4>
                                <p style="margin: 0.5rem 0; color: var(--text-muted); font-size: 0.875rem;">
                                    Certificate of Incorporation or Business Registration
                                </p>
                            </div>
                            <div>
                                <input type="file" id="registrationCert" accept=".pdf" style="display: none;" onchange="handleFileUpload('registrationCert', this)">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('registrationCert').click()">
                                    <i class="fas fa-upload"></i>
                                    Upload Certificate
                                </button>
                                <div id="registrationCert-status" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--success); display: none;">
                                    <i class="fas fa-check-circle"></i> Uploaded successfully
                                </div>
                            </div>
                        </div>
                        
                        <!-- ISO Certificates -->
                        <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 2rem; text-align: center; transition: border-color 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                            <div style="margin-bottom: 1rem;">
                                <i class="fas fa-certificate" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                                <h4 style="margin: 0; color: var(--dark);">ISO Certifications</h4>
                                <p style="margin: 0.5rem 0; color: var(--text-muted); font-size: 0.875rem;">
                                    ISO 14001 (Environmental), ISO 50001 (Energy), or other relevant certifications
                                </p>
                            </div>
                            <div>
                                <input type="file" id="isoCert" accept=".pdf" style="display: none;" onchange="handleFileUpload('isoCert', this)">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('isoCert').click()">
                                    <i class="fas fa-upload"></i>
                                    Upload ISO Certificate
                                </button>
                                <div id="isoCert-status" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--success); display: none;">
                                    <i class="fas fa-check-circle"></i> Uploaded successfully
                                </div>
                            </div>
                        </div>
                        
                        <!-- ESG Reports -->
                        <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 2rem; text-align: center; transition: border-color 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                            <div style="margin-bottom: 1rem;">
                                <i class="fas fa-chart-pie" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                                <h4 style="margin: 0; color: var(--dark);">ESG Reports</h4>
                                <p style="margin: 0.5rem 0; color: var(--text-muted); font-size: 0.875rem;">
                                    Environmental, Social, and Governance sustainability reports
                                </p>
                            </div>
                            <div>
                                <input type="file" id="esgReport" accept=".pdf" style="display: none;" onchange="handleFileUpload('esgReport', this)">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('esgReport').click()">
                                    <i class="fas fa-upload"></i>
                                    Upload ESG Report
                                </button>
                                <div id="esgReport-status" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--success); display: none;">
                                    <i class="fas fa-check-circle"></i> Uploaded successfully
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Account Status & Actions -->
    <div>
        <!-- Account Status -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h3><i class="fas fa-user-shield"></i> Account Status</h3>
            </div>
            <div class="card-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: {{ 'var(--success)' if company.verification_status == 'Verified' else 'var(--warning)' }}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                        <i class="fas fa-{{ 'shield-alt' if company.verification_status == 'Verified' else 'clock' }}"></i>
                    </div>
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--dark);">{{ company.verification_status }}</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">
                        {% if company.verification_status == 'Verified' %}
                        Your account is fully verified and can purchase carbon credits.
                        {% else %}
                        Account verification in progress. Upload required documents to complete.
                        {% endif %}
                    </p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Account Completeness</div>
                    <div class="progress">
                        <div class="progress-bar" style="width: 85%; background: var(--success);"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">85% Complete</div>
                </div>
                
                <div style="display: grid; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.875rem;">Profile Information</span>
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.875rem;">Company Documents</span>
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.875rem;">Wallet Configuration</span>
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.875rem;">ESG Compliance</span>
                        <i class="fas fa-clock" style="color: var(--warning);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h3><i class="fas fa-chart-line"></i> Account Summary</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem;">Member Since</span>
                        <span style="font-weight: 600;">{{ company.registration_date.strftime('%b %Y') if company.registration_date else 'Jan 2024' }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem;">Credits Purchased</span>
                        <span style="font-weight: 600; color: var(--success);">{{ "{:,}".format(company.credits_purchased) }} tCO₂e</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem;">Total Investment</span>
                        <span style="font-weight: 600; color: var(--primary);">₹{{ "{:,}".format(company.total_spent) }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 0.875rem;">Carbon Offset</span>
                        <span style="font-weight: 600; color: var(--warning);">{{ ((company.credits_retired / company.annual_emissions * 100)|round(1)) if company.annual_emissions > 0 else 0 }}%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            </div>
            <div class="card-body">
                <div style="display: grid; gap: 1rem;">
                    <button class="btn btn-primary" onclick="location.href='/industry/marketplace'">
                        <i class="fas fa-shopping-cart"></i>
                        Buy Carbon Credits
                    </button>
                    <button class="btn btn-outline" onclick="location.href='/industry/reports'">
                        <i class="fas fa-download"></i>
                        Download Reports
                    </button>
                    <button class="btn btn-outline" onclick="requestVerification()">
                        <i class="fas fa-shield-alt"></i>
                        Request Verification
                    </button>
                    <button class="btn btn-outline" onclick="contactSupport()">
                        <i class="fas fa-life-ring"></i>
                        Contact Support
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bank Details Modal -->
<div id="bankModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-university"></i> Bank Account Details</h3>
            <span class="close" onclick="closeBankModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="bankForm">
                <div class="form-group">
                    <label class="form-label">Bank Name</label>
                    <input type="text" class="form-control" id="bankName" placeholder="Enter bank name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" class="form-control" id="accountNumber" placeholder="Enter account number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">IFSC Code</label>
                    <input type="text" class="form-control" id="ifscCode" placeholder="Enter IFSC code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Holder Name</label>
                    <input type="text" class="form-control" id="accountHolder" placeholder="Enter account holder name">
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="closeBankModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i>
                        Save Details
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function saveProfile() {
    const formData = {
        industry_type: document.getElementById('industryType').value,
        address: document.getElementById('address').value,
        contact_person: document.getElementById('contactPerson').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        annual_emissions: parseFloat(document.getElementById('annualEmissions').value)
    };
    
    fetch('/industry/profile/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: Object.keys(formData).map(key => 
            key + '=' + encodeURIComponent(formData[key])
        ).join('&')
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message || 'Failed to update profile', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to update profile', 'error');
    });
}

function handleFileUpload(fileType, input) {
    const file = input.files[0];
    if (file) {
        if (file.type !== 'application/pdf') {
            showNotification('Please upload PDF files only', 'error');
            input.value = '';
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            showNotification('File size must be less than 10MB', 'error');
            input.value = '';
            return;
        }
        
        // Simulate upload
        showNotification(`${file.name} uploaded successfully`, 'success');
        document.getElementById(`${fileType}-status`).style.display = 'block';
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    navigator.clipboard.writeText(element.value).then(() => {
        showNotification('Wallet address copied to clipboard', 'success');
    });
}

function manageBankDetails() {
    document.getElementById('bankModal').style.display = 'flex';
}

function closeBankModal() {
    document.getElementById('bankModal').style.display = 'none';
}

function requestVerification() {
    showNotification('Verification request submitted. You will be contacted within 2-3 business days.', 'success');
}

function contactSupport() {
    showNotification('Support contact: support@bluecarbon.co.in | +91-1800-123-4567', 'info');
}

document.getElementById('bankForm').addEventListener('submit', function(e) {
    e.preventDefault();
    showNotification('Bank details saved securely', 'success');
    closeBankModal();
});

// Auto-save functionality
let autoSaveTimeout;
document.querySelectorAll('#profileForm input, #profileForm select, #profileForm textarea').forEach(input => {
    input.addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Auto-save logic here
            console.log('Auto-saving profile...');
        }, 2000);
    });
});
</script>
{% endblock %}