{% extends 'base.html' %}
{% set active='profile' %}
{% set title='Profile - BlueCarbon' %}
{% set header='Organization Profile' %}
{% block content %}
<div style="display: grid; gap: 24px;">
    <!-- Profile Header -->
    <div class="card">
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 24px;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-seedling" style="font-size: 32px; color: white;"></i>
            </div>
            <div>
                <h2 style="margin: 0;">{{ profile.name or 'Your Organization Name' }}</h2>
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                    <span class="badge success">
                        <i class="fas fa-check-circle"></i>
                        Verified NGO
                    </span>
                    <span class="badge primary">
                        <i class="fas fa-star"></i>
                        Member since {{ profile.join_date or '2024' }}
                    </span>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
                <div class="stat-label">Total Projects</div>
                <div class="stat-value" style="font-size: 24px;">{{ profile.total_projects or 0 }}</div>
            </div>
            <div>
                <div class="stat-label">Credits Earned</div>
                <div class="stat-value" style="font-size: 24px; color: var(--highlight);">{{ profile.total_credits or 0 }}</div>
            </div>
            <div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value" style="font-size: 24px; color: var(--success);">â‚¹{{ "{:,}".format(profile.total_revenue or 0) }}</div>
            </div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Organization Details -->
        <div class="card">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-building"></i>
                Organization Details
            </h3>
            <form method="post" action="#" id="profileForm">
                <div class="form-group">
                    <label for="name">Organization Name *</label>
                    <input type="text" id="name" name="name" class="form-control" value="{{ profile.name }}" required>
                </div>
                
                <div class="form-group">
                    <label for="type">Organization Type</label>
                    <select id="type" name="type" class="form-control">
                        <option value="ngo" {{ 'selected' if profile.type == 'ngo' else '' }}>NGO</option>
                        <option value="panchayat" {{ 'selected' if profile.type == 'panchayat' else '' }}>Panchayat</option>
                        <option value="cooperative" {{ 'selected' if profile.type == 'cooperative' else '' }}>Cooperative</option>
                        <option value="community" {{ 'selected' if profile.type == 'community' else '' }}>Community Group</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="registration_number">Registration Number</label>
                    <input type="text" id="registration_number" name="registration_number" class="form-control" value="{{ profile.registration_number }}">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="contact_person">Contact Person *</label>
                        <input type="text" id="contact_person" name="contact_person" class="form-control" value="{{ profile.contact_person }}" required>
                    </div>
                    <div class="form-group">
                        <label for="contact_phone">Phone Number *</label>
                        <input type="tel" id="contact_phone" name="contact_phone" class="form-control" value="{{ profile.contact_phone }}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" class="form-control" value="{{ profile.email }}" required>
                </div>
                
                <div class="form-group">
                    <label for="address">Complete Address *</label>
                    <textarea id="address" name="address" class="form-control" rows="3" required>{{ profile.address }}</textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="district">District</label>
                        <input type="text" id="district" name="district" class="form-control" value="{{ profile.district }}">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" id="state" name="state" class="form-control" value="{{ profile.state }}">
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Financial Details -->
        <div class="card">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-wallet"></i>
                Financial Details
            </h3>
            
            <div style="background: var(--hover); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                    <strong>Payment Information</strong>
                </div>
                <p style="margin: 0; font-size: 14px; color: #6B7280;">Credits revenue will be transferred to your preferred payment method.</p>
            </div>
            
            <div class="form-group">
                <label for="payment_method">Preferred Payment Method</label>
                <select id="payment_method" name="payment_method" class="form-control" onchange="togglePaymentFields()">
                    <option value="">Select payment method</option>
                    <option value="bank" {{ 'selected' if profile.payment_method == 'bank' else '' }}>Bank Account</option>
                    <option value="wallet" {{ 'selected' if profile.payment_method == 'wallet' else '' }}>Digital Wallet</option>
                    <option value="both" {{ 'selected' if profile.payment_method == 'both' else '' }}>Both</option>
                </select>
            </div>
            
            <div id="bankDetails" style="{{ 'display: none;' if profile.payment_method not in ['bank', 'both'] else '' }}">
                <div class="form-group">
                    <label for="bank_name">Bank Name</label>
                    <input type="text" id="bank_name" name="bank_name" class="form-control" value="{{ profile.bank_name }}">
                </div>
                
                <div class="form-group">
                    <label for="account_number">Account Number</label>
                    <input type="text" id="account_number" name="account_number" class="form-control" value="{{ profile.account_number }}">
                </div>
                
                <div class="form-group">
                    <label for="ifsc_code">IFSC Code</label>
                    <input type="text" id="ifsc_code" name="ifsc_code" class="form-control" value="{{ profile.ifsc_code }}">
                </div>
                
                <div class="form-group">
                    <label for="account_holder_name">Account Holder Name</label>
                    <input type="text" id="account_holder_name" name="account_holder_name" class="form-control" value="{{ profile.account_holder_name }}">
                </div>
            </div>
            
            <div id="walletDetails" style="{{ 'display: none;' if profile.payment_method not in ['wallet', 'both'] else '' }}">
                <div class="form-group">
                    <label for="wallet_address">Wallet Address</label>
                    <input type="text" id="wallet_address" name="wallet_address" class="form-control" value="{{ profile.wallet_address }}" placeholder="0x...">
                </div>
                
                <div class="form-group">
                    <label for="wallet_type">Wallet Type</label>
                    <select id="wallet_type" name="wallet_type" class="form-control">
                        <option value="metamask" {{ 'selected' if profile.wallet_type == 'metamask' else '' }}>MetaMask</option>
                        <option value="coinbase" {{ 'selected' if profile.wallet_type == 'coinbase' else '' }}>Coinbase Wallet</option>
                        <option value="trust" {{ 'selected' if profile.wallet_type == 'trust' else '' }}>Trust Wallet</option>
                        <option value="other" {{ 'selected' if profile.wallet_type == 'other' else '' }}>Other</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Credentials Section -->
    <div class="card">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-key"></i>
            Security & Login
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
                <h4>Update Password</h4>
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" class="form-control">
                </div>
            </div>
            
            <div>
                <h4>Two-Factor Authentication</h4>
                <div style="background: var(--hover); padding: 16px; border-radius: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <i class="fas fa-shield-alt" style="color: var(--success); font-size: 20px;"></i>
                        <div>
                            <div style="font-weight: 500;">Enhanced Security</div>
                            <div style="font-size: 12px; color: #6B7280;">Protect your account with 2FA</div>
                        </div>
                    </div>
                    <button id="toggle2FA" class="btn secondary" style="width: 100%;" onclick="toggle2FA()">
                        <i class="fas fa-mobile-alt"></i>
                        <span id="2faButtonText">{{ 'Disable Two-Factor Authentication' if profile.two_factor_enabled else 'Enable Two-Factor Authentication' }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button type="button" class="btn outline">
            <i class="fas fa-times"></i>
            Cancel
        </button>
        <button type="submit" form="profileForm" class="btn">
            <i class="fas fa-save"></i>
            Save Changes
        </button>
    </div>
</div>

<!-- 2FA Modal -->
<div id="twoFactorModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div style="position: relative; margin: 5% auto; padding: 20px; width: 80%; max-width: 500px; background: white; border-radius: 12px;">
        <span onclick="closeTwoFactorModal()" style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer;">&times;</span>
        <h3 id="modalTitle">Setup Two-Factor Authentication</h3>
        <div id="qrCodeSection" style="display: none; text-align: center; margin: 20px 0;">
            <p>Scan this QR code with your authenticator app:</p>
            <img id="qrCodeImage" style="max-width: 200px;" />
            <p><strong>Secret Key:</strong> <code id="secretKey"></code></p>
            <div>
                <label>Enter verification code:</label>
                <input type="text" id="verificationCode" placeholder="6-digit code" maxlength="6" style="padding: 8px; margin: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                <button onclick="verify2FA()" class="btn">Verify & Enable</button>
            </div>
        </div>
        <div id="loadingSection">Setting up 2FA...</div>
    </div>
</div>

<script>
function togglePaymentFields() {
    const paymentMethod = document.getElementById('payment_method').value;
    const bankDetails = document.getElementById('bankDetails');
    const walletDetails = document.getElementById('walletDetails');
    
    if (paymentMethod === 'bank') {
        bankDetails.style.display = 'block';
        walletDetails.style.display = 'none';
    } else if (paymentMethod === 'wallet') {
        bankDetails.style.display = 'none';
        walletDetails.style.display = 'block';
    } else if (paymentMethod === 'both') {
        bankDetails.style.display = 'block';
        walletDetails.style.display = 'block';
    } else {
        bankDetails.style.display = 'none';
        walletDetails.style.display = 'none';
    }
}

// Real-time form updates
let formChanged = false;
let currentTwoFactorStatus = {{ 'true' if profile.two_factor_enabled else 'false' }};

// Monitor form changes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
            showSaveIndicator();
        });
    });
    
    // Auto-save functionality
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfile();
    });
    
    // Real-time validation
    inputs.forEach(input => {
        if (input.type === 'email') {
            input.addEventListener('blur', validateEmail);
        }
        if (input.type === 'tel') {
            input.addEventListener('blur', validatePhone);
        }
    });
});

function showSaveIndicator() {
    const saveBtn = document.querySelector('button[form="profileForm"]');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes *';
        saveBtn.style.background = 'var(--accent)';
    }
}

function saveProfile() {
    const form = document.getElementById('profileForm');
    const formData = new FormData(form);
    
    // Show loading state
    const saveBtn = document.querySelector('button[form="profileForm"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    fetch('/ngo/profile', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Profile updated successfully!');
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
            saveBtn.style.background = 'var(--success)';
            formChanged = false;
            
            // Reset after 2 seconds
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = '';
                saveBtn.disabled = false;
            }, 2000);
        } else {
            throw new Error(data.message || 'Save failed');
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        showErrorMessage('Failed to save profile. Please try again.');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function validateEmail() {
    const emailInput = this;
    const email = emailInput.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        emailInput.style.borderColor = 'var(--error)';
        showErrorMessage('Please enter a valid email address.');
    } else {
        emailInput.style.borderColor = '';
    }
}

function validatePhone() {
    const phoneInput = this;
    const phone = phoneInput.value;
    const phoneRegex = /^[+]?[1-9]\d{1,14}$/;
    
    if (phone && !phoneRegex.test(phone.replace(/[\s-]/g, ''))) {
        phoneInput.style.borderColor = 'var(--error)';
        showErrorMessage('Please enter a valid phone number.');
    } else {
        phoneInput.style.borderColor = '';
    }
}

function toggle2FA() {
    if (currentTwoFactorStatus) {
        // Disable 2FA
        if (confirm('Are you sure you want to disable Two-Factor Authentication?')) {
            // In production, implement disable 2FA functionality
            currentTwoFactorStatus = false;
            document.getElementById('2faButtonText').textContent = 'Enable Two-Factor Authentication';
            showSuccessMessage('Two-Factor Authentication disabled.');
        }
    } else {
        // Enable 2FA
        document.getElementById('twoFactorModal').style.display = 'block';
        setup2FA();
    }
}

function setup2FA() {
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('qrCodeSection').style.display = 'none';
    
    fetch('/ngo/2fa/setup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('qrCodeImage').src = data.qr_code;
            document.getElementById('secretKey').textContent = data.secret;
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('qrCodeSection').style.display = 'block';
        } else {
            showErrorMessage('Failed to setup 2FA. Please try again.');
            closeTwoFactorModal();
        }
    })
    .catch(error => {
        console.error('2FA setup error:', error);
        showErrorMessage('Failed to setup 2FA. Please try again.');
        closeTwoFactorModal();
    });
}

function verify2FA() {
    const code = document.getElementById('verificationCode').value;
    
    if (!code || code.length !== 6) {
        showErrorMessage('Please enter a 6-digit verification code.');
        return;
    }
    
    fetch('/ngo/2fa/enable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ code: code })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTwoFactorStatus = true;
            document.getElementById('2faButtonText').textContent = 'Disable Two-Factor Authentication';
            showSuccessMessage('Two-Factor Authentication enabled successfully!');
            closeTwoFactorModal();
        } else {
            showErrorMessage(data.message || 'Invalid verification code.');
        }
    })
    .catch(error => {
        console.error('2FA verification error:', error);
        showErrorMessage('Verification failed. Please try again.');
    });
}

function closeTwoFactorModal() {
    document.getElementById('twoFactorModal').style.display = 'none';
    document.getElementById('verificationCode').value = '';
}

function showSuccessMessage(message) {
    showNotification(message, 'success');
}

function showErrorMessage(message) {
    showNotification(message, 'error');
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    if (type === 'success') {
        notification.style.background = 'var(--success)';
        notification.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
    } else {
        notification.style.background = 'var(--error)';
        notification.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 4000);
}

// Warn user about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});
</script>
{% endblock %}


