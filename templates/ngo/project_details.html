{% extends 'ngo/ngo_base.html' %}
{% set active='projects' %}
{% set title='Project Details - NGO Portal' %}
{% set header='Project Details' %}

{% block content %}
<div style="margin-bottom: 20px;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <h2 style="margin: 0; color: #1f2937;">Project Details - {{ project.id }}</h2>
        <div style="display: flex; gap: 12px;">
            <a href="/ngo/projects" class="btn" style="background: #6b7280;">
                <i class="fas fa-arrow-left"></i> Back to Projects
            </a>
            {% if project.status in ['Verified'] %}
            <button onclick="downloadCertificate('{{ project.id }}')" class="btn">
                <i class="fas fa-certificate"></i> Download Certificate
            </button>
            {% endif %}
            {% if project.status in ['Needs Revision', 'Rejected'] %}
            <button onclick="showResubmitModal()" class="btn" style="background: #f59e0b;">
                <i class="fas fa-paper-plane"></i> Resubmit Project
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Project Status Banner -->
<div class="card" style="margin-bottom: 20px; {% if project.status == 'Verified' %}background: linear-gradient(135deg, #dcfce7, #f0fdf4);{% elif project.status == 'Pending Review' or project.status == 'Under Verification' %}background: linear-gradient(135deg, #fef3c7, #fffbeb);{% elif project.status == 'Needs Revision' %}background: linear-gradient(135deg, #fed7aa, #fef3c7);{% else %}background: linear-gradient(135deg, #fecaca, #fef2f2);{% endif %}">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 48px;">
                {% if project.status == 'Verified' %}‚úÖ
                {% elif project.status == 'Pending Review' or project.status == 'Under Verification' %}‚è≥
                {% elif project.status == 'Needs Revision' %}üîÑ
                {% else %}‚ùå{% endif %}
            </div>
            <div>
                <h3 style="margin: 0; color: #1f2937;">{{ project.name }}</h3>
                <p style="margin: 4px 0; color: #6b7280;">Status: 
                    <span class="badge {{ 'success' if project.status == 'Verified' else 'warning' if project.status in ['Pending Review', 'Under Verification', 'Needs Revision'] else 'danger' }}">
                        {{ project.status }}
                    </span>
                </p>
                {% if project.status == 'Verified' and project.approval_date %}
                <p style="margin: 4px 0; color: #059669; font-size: 14px;">
                    <i class="fas fa-check-circle"></i> Approved on {{ project.approval_date.strftime('%d %B %Y') }}
                </p>
                {% endif %}
            </div>
        </div>
        {% if project.status == 'Verified' and project.token_id %}
        <div style="text-align: center; padding: 16px; background: rgba(255,255,255,0.8); border-radius: 12px;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">BLOCKCHAIN TOKEN</div>
            <div style="font-weight: bold; color: #059669; font-size: 16px;">{{ project.token_id }}</div>
            <div style="font-size: 11px; color: #6b7280;">Immutable Record</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Admin Feedback (if any) -->
{% if project.admin_feedback or project.verification_notes %}
<div class="card" style="margin-bottom: 20px; border-left: 4px solid {% if project.status == 'Verified' %}#22c55e{% elif project.status == 'Needs Revision' %}#f59e0b{% else %}#ef4444{% endif %};">
    <h4 style="margin: 0 0 12px 0; color: #1f2937;">
        <i class="fas fa-comment-alt" style="color: #6b7280;"></i>
        {% if project.status == 'Verified' %}Verification Notes
        {% elif project.status == 'Needs Revision' %}Revision Required
        {% else %}Admin Feedback{% endif %}
    </h4>
    <p style="margin: 0; line-height: 1.6; color: #374151;">
        {{ project.admin_feedback or project.verification_notes }}
    </p>
    {% if project.status == 'Needs Revision' and project.get('revision_count', 0) > 0 %}
    <p style="margin: 8px 0 0 0; font-size: 14px; color: #6b7280;">
        <i class="fas fa-history"></i> Revision #{{ project.revision_count }}
    </p>
    {% endif %}
</div>
{% endif %}

<!-- Project Information Grid -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    
    <!-- Basic Information -->
    <div class="card">
        <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
            Basic Information
        </h4>
        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Project ID:</span>
                <strong>{{ project.id }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Organization:</span>
                <strong>{{ project.ngo_name }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Ecosystem Type:</span>
                <span class="badge primary">{{ project.ecosystem }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Project Area:</span>
                <strong>{{ project.area }} hectares</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Location:</span>
                <strong>{{ project.admin_area }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Start Date:</span>
                <strong>{{ project.start_date or 'Not specified' }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                <span style="color: #6b7280;">Submission Date:</span>
                <strong>{{ project.submission_date.strftime('%d %B %Y, %I:%M %p') }}</strong>
            </div>
        </div>
    </div>

    <!-- Tree Information -->
    <div class="card">
        <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
            <i class="fas fa-tree" style="color: #22c55e;"></i>
            Tree Information
        </h4>
        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Number of Trees:</span>
                <strong style="color: #059669; font-size: 18px;">{{ project.number_of_trees or 'Not specified' }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Tree Species:</span>
                <strong>{{ project.tree_species or project.species or 'Not specified' }}</strong>
            </div>
            {% if project.tree_height and project.tree_dbh %}
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Average Height:</span>
                <strong>{{ project.tree_height }} meters</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Average DBH:</span>
                <strong>{{ project.tree_dbh }} meters</strong>
            </div>
            {% if project.tree_age %}
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Average Age:</span>
                <strong>{{ project.tree_age }} years</strong>
            </div>
            {% endif %}
            {% endif %}
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                <span style="color: #6b7280;">Species List:</span>
                <div style="text-align: right;">
                    {% if project.species %}
                        {% for species in project.species.split(',') %}
                        <span class="badge outline" style="margin: 2px;">{{ species.strip() }}</span>
                        {% endfor %}
                    {% else %}
                        <span style="color: #9ca3af;">Not specified</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Carbon Credit Information -->
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-leaf" style="color: #10b981;"></i>
        Carbon Credit Analysis
    </h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #059669; font-size: 14px; margin-bottom: 8px;">CREDITS REQUESTED</div>
            <div style="font-size: 32px; font-weight: bold; color: #047857;">{{ project.credits_requested or project.carbon_credits }}</div>
            <div style="color: #065f46; font-size: 14px;">tCO‚ÇÇe</div>
        </div>
        
        {% if project.status == 'Verified' and project.credits_approved %}
        <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #059669; font-size: 14px; margin-bottom: 8px;">CREDITS APPROVED</div>
            <div style="font-size: 32px; font-weight: bold; color: #047857;">{{ project.credits_approved }}</div>
            <div style="color: #065f46; font-size: 14px;">tCO‚ÇÇe</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #fef3c7, #fef08a); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #d97706; font-size: 14px; margin-bottom: 8px;">REVENUE EARNED</div>
            <div style="font-size: 24px; font-weight: bold; color: #b45309;">‚Çπ{{ "{:,.0f}".format((project.credits_approved or 0) * 2500) }}</div>
            <div style="color: #92400e; font-size: 12px;">@ ‚Çπ2,500 per credit</div>
        </div>
        {% endif %}
        
        {% if project.number_of_trees and (project.credits_requested or project.carbon_credits) %}
        <div style="background: linear-gradient(135deg, #f0f9ff, #dbeafe); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #2563eb; font-size: 14px; margin-bottom: 8px;">PER TREE AVERAGE</div>
            <div style="font-size: 24px; font-weight: bold; color: #1d4ed8;">
                {{ "%.3f"|format((project.credits_requested or project.carbon_credits) / project.number_of_trees) }}
            </div>
            <div style="color: #1e40af; font-size: 14px;">tCO‚ÇÇe/tree</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Project Description -->
{% if project.description %}
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-file-alt" style="color: #6b7280;"></i>
        Project Description
    </h4>
    <p style="line-height: 1.6; color: #374151;">{{ project.description }}</p>
</div>
{% endif %}

<!-- MRV Workflow Information -->
{% if project.get('workflow_id') %}
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-cogs" style="color: #8b5cf6;"></i>
        MRV Verification Status
    </h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <div style="color: #6b7280; font-size: 14px;">Workflow ID</div>
            <div style="font-weight: 600; font-family: monospace;">{{ project.workflow_id }}</div>
        </div>
        {% if project.get('blockchain_hash') %}
        <div>
            <div style="color: #6b7280; font-size: 14px;">Blockchain Record</div>
            <div style="font-weight: 600; font-family: monospace; color: #059669;">{{ project.blockchain_hash[:20] }}...</div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
{% if project.status in ['Verified'] %}
<div class="card">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-bolt" style="color: #f59e0b;"></i>
        Quick Actions
    </h4>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <a href="/ngo/satellite-monitoring/{{ project.id }}" class="btn">
            <i class="fas fa-satellite"></i> View Satellite Data
        </a>
        <a href="/ngo/credits" class="btn" style="background: #059669;">
            <i class="fas fa-coins"></i> Manage Credits
        </a>
        <button onclick="shareProject('{{ project.id }}')" class="btn" style="background: #6366f1;">
            <i class="fas fa-share"></i> Share Project
        </button>
    </div>
</div>
{% endif %}

<!-- Resubmit Modal -->
<div id="resubmitModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Resubmit Project</h3>
            <span class="close" onclick="closeResubmitModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="resubmitForm" method="POST" action="/ngo/projects/{{ project.id }}/resubmit">
                <div class="form-group">
                    <label for="resubmission_notes">What changes have you made?</label>
                    <textarea id="resubmission_notes" name="resubmission_notes" rows="4" class="form-control" placeholder="Describe the changes you've made based on admin feedback..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="updated_description">Updated Project Description (optional):</label>
                    <textarea id="updated_description" name="updated_description" rows="3" class="form-control" placeholder="Enter updated project description if changed...">{{ project.description or '' }}</textarea>
                </div>
                
                <div class="row" style="display: flex; gap: 16px;">
                    <div class="col" style="flex: 1;">
                        <div class="form-group">
                            <label for="updated_area">Project Area (hectares):</label>
                            <input type="number" step="0.01" id="updated_area" name="updated_area" class="form-control" value="{{ project.area or '' }}" placeholder="e.g., 25.5">
                        </div>
                    </div>
                    <div class="col" style="flex: 1;">
                        <div class="form-group">
                            <label for="updated_credits_requested">Credits Requested:</label>
                            <input type="number" id="updated_credits_requested" name="updated_credits_requested" class="form-control" value="{{ project.credits_requested or '' }}" placeholder="e.g., 500">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="updated_location">Project Location:</label>
                    <input type="text" id="updated_location" name="updated_location" class="form-control" value="{{ project.location or '' }}" placeholder="e.g., Sundarbans, West Bengal">
                </div>
                
                <div class="form-group">
                    <label for="updated_ecosystem">Ecosystem Type:</label>
                    <select id="updated_ecosystem" name="updated_ecosystem" class="form-control">
                        <option value="">Select ecosystem type...</option>
                        <option value="Mangrove" {{ 'selected' if project.ecosystem == 'Mangrove' else '' }}>Mangrove</option>
                        <option value="Seagrass" {{ 'selected' if project.ecosystem == 'Seagrass' else '' }}>Seagrass</option>
                        <option value="Coastal Wetlands" {{ 'selected' if project.ecosystem == 'Coastal Wetlands' else '' }}>Coastal Wetlands</option>
                        <option value="Marine Forest" {{ 'selected' if project.ecosystem == 'Marine Forest' else '' }}>Marine Forest</option>
                        <option value="Coral Reef" {{ 'selected' if project.ecosystem == 'Coral Reef' else '' }}>Coral Reef</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="updated_methodology">Updated Methodology (optional):</label>
                    <textarea id="updated_methodology" name="updated_methodology" rows="2" class="form-control" placeholder="Enter updated methodology if changed...">{{ project.methodology or '' }}</textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" onclick="closeResubmitModal()" class="btn secondary">Cancel</button>
                    <button type="submit" class="btn primary">
                        <i class="fas fa-paper-plane"></i> Resubmit Project
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function downloadCertificate(projectId) {
    // Placeholder for certificate download
    alert('Certificate download functionality will be implemented soon!');
}

function shareProject(projectId) {
    if (navigator.share) {
        navigator.share({
            title: '{{ project.name }}',
            text: 'Check out our verified carbon credit project!',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        showNotification('Project link copied to clipboard!', 'success');
    }
}

function showResubmitModal() {
    document.getElementById('resubmitModal').style.display = 'block';
}

function closeResubmitModal() {
    document.getElementById('resubmitModal').style.display = 'none';
}

// Handle resubmit form submission
document.getElementById('resubmitForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification(data.message, 'error');
        }
        closeResubmitModal();
    })
    .catch(error => {
        showNotification('An error occurred. Please try again.', 'error');
        closeResubmitModal();
    });
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('resubmitModal');
    if (event.target === modal) {
        closeResubmitModal();
    }
}
</script>

<style>
.badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge.success {
    background: #dcfce7;
    color: #166534;
}

.badge.warning {
    background: #fef3c7;
    color: #92400e;
}

.badge.danger {
    background: #fecaca;
    color: #991b1b;
}

.badge.primary {
    background: #dbeafe;
    color: #1d4ed8;
}

.badge.outline {
    background: transparent;
    border: 1px solid #d1d5db;
    color: #374151;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    max-width: 400px;
}

.notification.success {
    background: #22c55e;
}

.notification.error {
    background: #ef4444;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
    margin: 0;
    color: #1f2937;
}

.close {
    color: #9ca3af;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #374151;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

.btn.secondary {
    background: #6b7280;
}

.btn.secondary:hover {
    background: #4b5563;
}

@media (max-width: 768px) {
    .content {
        padding: 15px;
    }
    
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    .modal-content {
        margin: 10% auto;
        width: 95%;
    }
}
</style>

{% endblock %}