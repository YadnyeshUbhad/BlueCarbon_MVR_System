{% extends 'admin_base.html' %}
{% set active='admins' %}
{% set title='Add New Admin - NCCR Admin' %}
{% set header='Add New Admin' %}

{% block content %}
<div style="display: grid; gap: 24px; max-width: 800px; margin: 0 auto;">
    <!-- Header Section -->
    <div style="display: flex; align-items: center; gap: 16px;">
        <a href="{{ url_for('admin.admins_management') }}" class="btn outline">
            <i class="fas fa-arrow-left"></i> Back to Admin Management
        </a>
        <div>
            <h2 style="margin: 0; color: #1f2937;">Create New Administrator Account</h2>
            <p style="color: #6b7280; margin: 4px 0 0 0;">Add a new NCCR administrator with full system access</p>
        </div>
    </div>

    <!-- Security Warning -->
    <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 16px; border-radius: 12px;">
        <div style="display: flex; align-items: center; gap: 12px; color: #b91c1c;">
            <i class="fas fa-shield-alt" style="font-size: 20px;"></i>
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;">Security Advisory</div>
                <div style="font-size: 14px;">
                    Administrator accounts have full access to the NCCR system. Only create accounts for trusted personnel who require administrative privileges.
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Creation Form -->
    <div class="card">
        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-user-plus" style="color: var(--primary);"></i>
                Administrator Account Details
            </h3>
        </div>
        
        <form id="addAdminForm" style="padding: 20px;">
            <div style="display: grid; gap: 20px;">
                <!-- Personal Information -->
                <div>
                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-user" style="color: var(--info);"></i>
                        Personal Information
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <input type="text" id="name" name="name" required 
                                   placeholder="Enter full name"
                                   style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Official Email Address *</label>
                            <input type="email" id="email" name="email" required 
                                   placeholder="admin@nccr.gov.in"
                                   style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <!-- Organization Details -->
                <div>
                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-building" style="color: var(--warning);"></i>
                        Organization Details
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label for="organization">Organization *</label>
                            <input type="text" id="organization" name="organization" required 
                                   placeholder="NCCR - Ministry of Environment"
                                   value="NCCR"
                                   style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="department">Department/Division</label>
                            <input type="text" id="department" name="department" 
                                   placeholder="e.g., Carbon Registry Division"
                                   style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 16px;">
                        <label for="designation">Job Title/Designation</label>
                        <input type="text" id="designation" name="designation" 
                               placeholder="e.g., Senior Technical Officer"
                               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>

                <!-- Security & Access -->
                <div>
                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-lock" style="color: var(--danger);"></i>
                        Security & Access
                    </h4>
                    
                    <div class="form-group">
                        <label for="password">Temporary Password *</label>
                        <div style="position: relative;">
                            <input type="password" id="password" name="password" required 
                                   placeholder="Generate secure temporary password"
                                   minlength="8"
                                   style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; padding-right: 100px;">
                            <button type="button" onclick="generatePassword()" 
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                Generate
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                            Password must be at least 8 characters with uppercase, lowercase, number and special character
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">Confirm Password *</label>
                        <input type="password" id="confirm_password" name="confirm_password" required 
                               placeholder="Confirm the temporary password"
                               minlength="8"
                               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" id="force_password_change" name="force_password_change" checked>
                            <span>Force password change on first login</span>
                        </label>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px; margin-left: 24px;">
                            Recommended for security. The new admin will be required to set a new password upon first login.
                        </div>
                    </div>
                </div>

                <!-- Verification & Notifications -->
                <div>
                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-bell" style="color: var(--success);"></i>
                        Notifications & Verification
                    </h4>
                    
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: grid; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="send_welcome_email" name="send_welcome_email" checked>
                                <span>Send welcome email with login credentials</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="require_email_verification" name="require_email_verification" checked>
                                <span>Require email verification before account activation</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="notify_existing_admins" name="notify_existing_admins" checked>
                                <span>Notify existing administrators about new admin account</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Admin Verification -->
                <div>
                    <h4 style="margin: 0 0 16px 0; color: #374151; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-user-check" style="color: var(--primary);"></i>
                        Administrator Verification
                    </h4>
                    
                    <div class="form-group">
                        <label for="admin_password">Your Password (for verification) *</label>
                        <input type="password" id="admin_password" name="admin_password" required 
                               placeholder="Enter your current password to confirm"
                               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                            Required to verify your identity before creating a new administrator account
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="submit" class="btn" style="flex: 1;">
                        <i class="fas fa-user-plus"></i>
                        Create Administrator Account
                    </button>
                    
                    <button type="button" onclick="resetForm()" class="btn outline">
                        <i class="fas fa-undo"></i>
                        Reset Form
                    </button>
                    
                    <a href="{{ url_for('admin.admins_management') }}" class="btn outline">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('addAdminForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const password = formData.get('password');
    const confirmPassword = formData.get('confirm_password');
    
    // Validate password match
    if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    // Validate password strength
    if (!isStrongPassword(password)) {
        showNotification('Password must contain at least 8 characters with uppercase, lowercase, number, and special character', 'error');
        return;
    }
    
    // Submit form
    showNotification('Creating administrator account...', 'info');
    
    fetch('/admin/admins/new', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("admin.admins_management") }}';
            }, 2000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Failed to create admin account. Please try again.', 'error');
    });
});

function generatePassword() {
    const length = 12;
    const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lowercase = 'abcdefghijklmnopqrstuvwxyz';
    const numbers = '0123456789';
    const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
    const allChars = uppercase + lowercase + numbers + symbols;
    
    let password = '';
    
    // Ensure at least one character from each category
    password += uppercase[Math.floor(Math.random() * uppercase.length)];
    password += lowercase[Math.floor(Math.random() * lowercase.length)];
    password += numbers[Math.floor(Math.random() * numbers.length)];
    password += symbols[Math.floor(Math.random() * symbols.length)];
    
    // Fill the rest randomly
    for (let i = 4; i < length; i++) {
        password += allChars[Math.floor(Math.random() * allChars.length)];
    }
    
    // Shuffle the password
    password = password.split('').sort(() => Math.random() - 0.5).join('');
    
    document.getElementById('password').value = password;
    document.getElementById('confirm_password').value = password;
    
    showNotification('Secure password generated', 'success');
}

function isStrongPassword(password) {
    const minLength = 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasNonalphas = /\W/.test(password);
    
    return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasNonalphas;
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('addAdminForm').reset();
        document.getElementById('organization').value = 'NCCR';
        document.getElementById('force_password_change').checked = true;
        document.getElementById('send_welcome_email').checked = true;
        document.getElementById('require_email_verification').checked = true;
        document.getElementById('notify_existing_admins').checked = true;
        showNotification('Form reset successfully', 'info');
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    if (type === 'success') {
        notification.style.background = '#10b981';
        notification.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
    } else if (type === 'error') {
        notification.style.background = '#ef4444';
        notification.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
    } else if (type === 'info') {
        notification.style.background = '#3b82f6';
        notification.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 4000);
}

// Real-time password validation
document.getElementById('password').addEventListener('input', function(e) {
    const password = e.target.value;
    const isStrong = isStrongPassword(password);
    
    if (password.length > 0) {
        if (isStrong) {
            e.target.style.border = '1px solid #10b981';
        } else {
            e.target.style.border = '1px solid #ef4444';
        }
    } else {
        e.target.style.border = '1px solid #d1d5db';
    }
});

// Real-time password confirmation
document.getElementById('confirm_password').addEventListener('input', function(e) {
    const confirmPassword = e.target.value;
    const password = document.getElementById('password').value;
    
    if (confirmPassword.length > 0) {
        if (confirmPassword === password) {
            e.target.style.border = '1px solid #10b981';
        } else {
            e.target.style.border = '1px solid #ef4444';
        }
    } else {
        e.target.style.border = '1px solid #d1d5db';
    }
});

// Email validation
document.getElementById('email').addEventListener('input', function(e) {
    const email = e.target.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email.length > 0) {
        if (emailRegex.test(email)) {
            e.target.style.border = '1px solid #10b981';
        } else {
            e.target.style.border = '1px solid #ef4444';
        }
    } else {
        e.target.style.border = '1px solid #d1d5db';
    }
});
</script>
{% endblock %}