{% extends 'admin_base.html' %}
{% set active='projects' %}
{% set title='Projects Management - NCCR Admin' %}
{% set header='Projects Management' %}

{% block content %}
<div class="admin-header">
    <h2 style="margin: 0; color: #1f2937;">Projects Management</h2>
    <div class="admin-actions">
        <a href="/admin/export/projects" class="btn secondary">
            <i class="fas fa-download"></i> Export Data
        </a>
    </div>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab-btn {{ 'active' if tab == 'pending' else '' }}" onclick="switchTab('pending')">
        <i class="fas fa-clock"></i>
        Pending Verification
        <span class="badge warning">{{ projects|selectattr('status', 'in', ['Pending Review', 'Documents Missing', 'Under Verification'])|list|length }}</span>
    </button>
    <button class="tab-btn {{ 'active' if tab == 'verified' else '' }}" onclick="switchTab('verified')">
        <i class="fas fa-check-circle"></i>
        Verified Projects
        <span class="badge success">{{ projects|selectattr('status', 'equalto', 'Verified')|list|length }}</span>
    </button>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 20px;">
    <form method="get" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
        <input type="hidden" name="tab" value="{{ tab }}">
        
        <div style="display: flex; gap: 8px; align-items: center;">
            <i class="fas fa-search" style="color: #6b7280;"></i>
            <input name="search" placeholder="Search projects, NGOs, or Project ID" 
                   value="{{ search }}" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; min-width: 250px;">
        </div>
        
        <select name="ecosystem" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <option value="">All Ecosystems</option>
            {% for eco in ecosystems %}
            <option value="{{ eco }}" {{ 'selected' if ecosystem_filter == eco }}>{{ eco }}</option>
            {% endfor %}
        </select>
        
        {% if tab == 'pending' %}
        <select name="status" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
            <option value="">All Status</option>
            <option value="Pending Review" {{ 'selected' if status_filter == 'Pending Review' }}>Pending Review</option>
            <option value="Documents Missing" {{ 'selected' if status_filter == 'Documents Missing' }}>Documents Missing</option>
            <option value="Under Verification" {{ 'selected' if status_filter == 'Under Verification' }}>Under Verification</option>
        </select>
        {% endif %}
        
        <button type="submit" class="btn primary">
            <i class="fas fa-filter"></i> Filter
        </button>
        
        <a href="/admin/projects?tab={{ tab }}" class="btn outline">
            <i class="fas fa-times"></i> Clear
        </a>
    </form>
</div>

<!-- Projects Table -->
<div class="card">
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Project Details</th>
                    <th>NGO/Panchayat</th>
                    <th>Location</th>
                    <th>Ecosystem & Area</th>
                    <th>Trees</th>
                    {% if tab == 'pending' %}
                    <th>Credits Requested</th>
                    <th>Submission Date</th>
                    <th>Status</th>
                    {% else %}
                    <th>Credits Approved</th>
                    <th>Approval Date</th>
                    <th>Token ID</th>
                    {% endif %}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr>
                    <td>
                        <div style="font-weight: 600; color: #1f2937;">{{ project.name }}</div>
                        <div style="font-size: 12px; color: #6b7280;">{{ project.id }}</div>
                    </td>
                    <td>
                        <div style="font-weight: 500;">{{ project.ngo_name }}</div>
                        <div style="font-size: 12px; color: #6b7280;">{{ project.contact_person }}</div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-map-pin" style="color: #ef4444;"></i>
                            <div>
                                <div style="font-weight: 500;">{{ project.district }}</div>
                                <div style="font-size: 12px; color: #6b7280;">{{ project.state }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>
                            <span class="badge primary">{{ project.ecosystem }}</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">{{ project.area }} ha</div>
                    </td>
                    <td>
                        <div style="font-weight: 600; color: #059669;">{{ project.number_of_trees or 'N/A' }}</div>
                        <div style="font-size: 12px; color: #6b7280;">trees</div>
                    </td>
                    {% if tab == 'pending' %}
                    <td>
                        <div style="font-weight: 600; color: #059669;">{{ project.credits_requested }} tCO₂e</div>
                    </td>
                    <td>
                        <div>{{ project.submission_date.strftime('%d %b %Y') }}</div>
                        <div style="font-size: 12px; color: #6b7280;">{{ (datetime.now() - project.submission_date).days }} days ago</div>
                    </td>
                    <td>
                        <span class="badge {{ 'warning' if project.status == 'Pending Review' else 'danger' if project.status == 'Documents Missing' else 'info' }}">
                            {{ project.status }}
                        </span>
                    </td>
                    {% else %}
                    <td>
                        <div style="font-weight: 600; color: #059669;">{{ project.credits_approved }} tCO₂e</div>
                    </td>
                    <td>
                        <div>{{ project.approval_date.strftime('%d %b %Y') if project.approval_date }}</div>
                    </td>
                    <td>
                        <code style="font-size: 11px;">{{ project.token_id }}</code>
                    </td>
                    {% endif %}
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <a href="/admin/projects/{{ project.id }}" class="btn small primary" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if tab == 'pending' %}
                            <button onclick="approveProject('{{ project.id }}')" class="btn small success" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="rejectProject('{{ project.id }}')" class="btn small danger" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                            <button onclick="sendBackProject('{{ project.id }}')" class="btn small warning" title="Send Back">
                                <i class="fas fa-redo"></i>
                            </button>
                            {% else %}
                            <a href="#" onclick="viewOnBlockchain('{{ project.token_id }}')" class="btn small outline" title="View on Blockchain">
                                <i class="fas fa-link"></i>
                            </a>
                            <button onclick="downloadReport('{{ project.id }}')" class="btn small secondary" title="Download Report">
                                <i class="fas fa-download"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if projects|length == 0 %}
    <div style="text-align: center; padding: 40px; color: #6b7280;">
        <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
        <p>No projects found matching your criteria.</p>
    </div>
    {% endif %}
</div>

<!-- Action Modals -->
<div id="actionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Project Action</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="actionForm">
                <input type="hidden" id="projectId" name="project_id">
                <input type="hidden" id="actionType" name="action">
                
                <div class="form-group">
                    <label for="reason" id="reasonLabel">Reason:</label>
                    <textarea id="reason" name="reason" rows="4" class="form-control" placeholder="Enter reason for this action..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" onclick="closeModal()" class="btn secondary">Cancel</button>
                    <button type="submit" class="btn primary" id="confirmBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function switchTab(tab) {
    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    url.searchParams.delete('search');
    url.searchParams.delete('ecosystem');
    url.searchParams.delete('status');
    window.location.href = url.toString();
}

function approveProject(projectId) {
    showActionModal(projectId, 'approve', 'Approve Project', 'Add any approval notes (optional):', 'Approve & Issue Credits');
}

function rejectProject(projectId) {
    showActionModal(projectId, 'reject', 'Reject Project', 'Reason for rejection (required):', 'Reject Project');
}

function sendBackProject(projectId) {
    showActionModal(projectId, 'send_back', 'Send Back for Revision', 'What needs to be revised (required):', 'Send Back');
}

function showActionModal(projectId, action, title, reasonLabel, confirmText) {
    document.getElementById('projectId').value = projectId;
    document.getElementById('actionType').value = action;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('reasonLabel').textContent = reasonLabel;
    document.getElementById('confirmBtn').textContent = confirmText;
    document.getElementById('reason').required = action !== 'approve';
    document.getElementById('actionModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('actionModal').style.display = 'none';
    document.getElementById('actionForm').reset();
}

function viewOnBlockchain(tokenId) {
    window.open(`https://explorer.example.com/token/${tokenId}`, '_blank');
}

function downloadReport(projectId) {
    window.open(`/admin/projects/${projectId}/report`, '_blank');
}

// Handle form submission
document.getElementById('actionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const projectId = formData.get('project_id');
    
    fetch(`/admin/projects/${projectId}/action`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message, 'error');
        }
        closeModal();
    })
    .catch(error => {
        showNotification('An error occurred. Please try again.', 'error');
        closeModal();
    });
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('actionModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>

<style>
.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 4px;
}

.tab-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.tab-btn.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 2px 8px rgba(0,119,182,0.3);
}

.tab-btn:hover:not(.active) {
    background: var(--hover);
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.admin-actions {
    display: flex;
    gap: 12px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--white);
    margin: 15% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #000;
}

.btn.small {
    padding: 6px 10px;
    font-size: 12px;
}

.table-responsive {
    overflow-x: auto;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    max-width: 400px;
}

.notification.success {
    background: var(--success);
}

.notification.error {
    background: var(--danger);
}
</style>
{% endblock %}