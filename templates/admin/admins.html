{% extends 'admin_base.html' %}
{% set active='admins' %}
{% set title='Admin Management - NCCR Admin' %}
{% set header='Admin Management' %}

{% block content %}
<div style="display: grid; gap: 24px;">
    <!-- Header Section -->
    <div style="display: flex; justify-content: between; align-items: center;">
        <div>
            <h2 style="margin: 0; color: #1f2937;">Admin Users Management</h2>
            <p style="color: #6b7280; margin: 4px 0 0 0;">Manage NCCR administrator accounts and permissions</p>
        </div>
        <a href="{{ url_for('admin.add_new_admin') }}" class="btn">
            <i class="fas fa-user-plus"></i> Add New Admin
        </a>
    </div>

    <!-- Current Admin Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" style="color: var(--primary);">{{ admins|length }}</div>
            <div class="stat-label">
                <i class="fas fa-user-shield"></i> Total Administrators
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value" style="color: var(--success);">{{ admins|length if admins else 0 }}</div>
            <div class="stat-label">
                <i class="fas fa-building"></i> NCCR Official Accounts
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value" style="color: var(--info);">{{ (admins|length * 30) if admins else 0 }}</div>
            <div class="stat-label">
                <i class="fas fa-calendar"></i> Days Since First Admin
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value" style="color: var(--warning);">Active</div>
            <div class="stat-label">
                <i class="fas fa-shield-alt"></i> System Status
            </div>
        </div>
    </div>

    <!-- Admins Table -->
    <div class="card">
        <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: between; align-items: center;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-users-cog" style="color: var(--primary);"></i>
                Administrator Accounts
            </h3>
            <div style="font-size: 12px; color: #6b7280;">
                <i class="fas fa-info-circle"></i> Only administrators can create new admin accounts
            </div>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Admin Details</th>
                        <th>Organization</th>
                        <th>Account Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for admin in admins %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">
                                    {{ admin.name[0].upper() if admin.name else 'A' }}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">{{ admin.name or 'Admin User' }}</div>
                                    <div style="font-size: 12px; color: #6b7280;">{{ admin.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">{{ admin.organization or 'NCCR' }}</div>
                            <div style="font-size: 12px; color: #6b7280;">
                                {% if 'nccr' in admin.email.lower() %}
                                    <i class="fas fa-shield-alt" style="color: var(--success);"></i> Official Account
                                {% else %}
                                    <i class="fas fa-user" style="color: var(--info);"></i> External Admin
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">{{ admin.created_at[:10] if admin.created_at else 'Unknown' }}</div>
                            <div style="font-size: 12px; color: #6b7280;">
                                {% if admin.created_at %}
                                    {{ ((now() - (admin.created_at | to_datetime)).days) }} days ago
                                {% else %}
                                    Recently created
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge success">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn small outline" title="View Details" onclick="viewAdminDetails({{ admin.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if admin.id != session.get('user_id') %}
                                <button class="btn small warning" title="Reset Password" onclick="resetAdminPassword({{ admin.id }})">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn small danger" title="Delete Admin" onclick="deleteAdmin({{ admin.id }}, '{{ admin.name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% else %}
                                <span class="badge primary" style="font-size: 10px; padding: 4px 8px;">
                                    <i class="fas fa-user"></i> You
                                </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if admins|length == 0 %}
        <div style="text-align: center; padding: 40px; color: #6b7280;">
            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
            <p>No administrators found.</p>
        </div>
        {% endif %}
    </div>

    <!-- Security Notice -->
    <div style="background: #fef3c7; border: 1px solid #fde68a; padding: 16px; border-radius: 12px;">
        <div style="display: flex; align-items: center; gap: 12px; color: #92400e;">
            <i class="fas fa-exclamation-triangle" style="font-size: 20px;"></i>
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;">Security Notice</div>
                <div style="font-size: 14px;">
                    • Only create admin accounts for trusted NCCR personnel<br>
                    • All admin activities are logged and monitored<br>
                    • Use strong passwords and enable 2FA when available<br>
                    • Regularly review and audit administrator access
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Details Modal -->
<div id="adminDetailsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Admin Details</h3>
            <span class="close" onclick="closeAdminModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="adminDetailsContent"></div>
        </div>
    </div>
</div>

<script>
function viewAdminDetails(adminId) {
    // In production, this would fetch admin details
    const adminDetailsContent = `
        <div class="card" style="margin-bottom: 16px;">
            <h4>Admin Information</h4>
            <div style="display: grid; gap: 8px; font-size: 14px;">
                <div><strong>ID:</strong> ${adminId}</div>
                <div><strong>Permissions:</strong> Full Admin Access</div>
                <div><strong>Last Login:</strong> 2 hours ago</div>
                <div><strong>IP Address:</strong> 192.168.1.100</div>
                <div><strong>Session Status:</strong> Active</div>
            </div>
        </div>
        
        <div class="card">
            <h4>Recent Activities</h4>
            <div style="font-size: 13px; color: #6b7280;">
                • Approved project PROJ1024 (2 hours ago)<br>
                • Verified NGO "Green Earth Foundation" (4 hours ago)<br>
                • Exported revenue data (1 day ago)<br>
                • Updated system settings (2 days ago)
            </div>
        </div>
    `;
    
    document.getElementById('adminDetailsContent').innerHTML = adminDetailsContent;
    document.getElementById('adminDetailsModal').style.display = 'block';
}

function resetAdminPassword(adminId) {
    if (confirm('Send password reset email to this administrator?')) {
        fetch(`/admin/admins/${adminId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Failed to send reset email', 'error');
        });
    }
}

function deleteAdmin(adminId, adminName) {
    if (confirm(`Are you sure you want to delete admin "${adminName}"? This action cannot be undone.`)) {
        fetch(`/admin/admins/${adminId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Failed to delete admin', 'error');
        });
    }
}

function closeAdminModal() {
    document.getElementById('adminDetailsModal').style.display = 'none';
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    if (type === 'success') {
        notification.style.background = '#10b981';
        notification.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
    } else {
        notification.style.background = '#ef4444';
        notification.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 4000);
}

// Modal styling
document.head.insertAdjacentHTML('beforeend', `
<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
}

.modal-content {
    position: relative;
    margin: 5% auto;
    padding: 20px;
    width: 80%;
    max-width: 600px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.modal-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
}

.close {
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
}

.close:hover {
    color: #374151;
}
</style>
`);
</script>
{% endblock %}