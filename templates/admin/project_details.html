{% extends 'admin_base.html' %}
{% set active='projects' %}
{% set title='Project Details - NCCR Admin' %}
{% set header='Project Details' %}

{% block content %}
{% set total_uploaded_files = (1 if project.baseline_file else 0) + (project.uploaded_images|length if project.uploaded_images else 0) %}
<div class="admin-header">
    <h2 style="margin: 0; color: #1f2937;">Project Details - {{ project.id }}</h2>
    <div class="admin-actions">
        <a href="/admin/projects" class="btn secondary">
            <i class="fas fa-arrow-left"></i> Back to Projects
        </a>
        {% if project.status == 'Verified' %}
        <button onclick="downloadReport('{{ project.id }}')" class="btn primary">
            <i class="fas fa-download"></i> Download Report
        </button>
        {% endif %}
    </div>
</div>

<!-- Project Status Banner -->
<div class="card" style="margin-bottom: 20px; {% if project.status == 'Verified' %}background: linear-gradient(135deg, #dcfce7, #f0fdf4);{% elif project.status == 'Pending Review' %}background: linear-gradient(135deg, #fef3c7, #fffbeb);{% else %}background: linear-gradient(135deg, #fecaca, #fef2f2);{% endif %}">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 48px;">
                {% if project.status == 'Verified' %}‚úÖ
                {% elif project.status == 'Pending Review' %}‚è≥
                {% else %}‚ùå{% endif %}
            </div>
            <div>
                <h3 style="margin: 0; color: #1f2937;">{{ project.name }}</h3>
                <p style="margin: 4px 0; color: #6b7280;">Status: 
                    <span class="badge {{ 'success' if project.status == 'Verified' else 'warning' if project.status == 'Pending Review' else 'danger' }}">
                        {{ project.status }}
                    </span>
                </p>
            </div>
        </div>
        {% if project.status != 'Verified' %}
        <div style="display: flex; gap: 8px;">
            <button onclick="approveProject('{{ project.id }}')" class="btn success">
                <i class="fas fa-check"></i> Approve
            </button>
            <button onclick="sendBackProject('{{ project.id }}')" class="btn warning">
                <i class="fas fa-redo"></i> Send Back
            </button>
            <button onclick="rejectProject('{{ project.id }}')" class="btn danger">
                <i class="fas fa-times"></i> Reject
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Project Information Grid -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    
    <!-- Basic Information -->
    <div class="card">
        <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
            Basic Information
        </h4>
        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Project ID:</span>
                <strong>{{ project.id }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">NGO/Organization:</span>
                <strong>{{ project.ngo_name }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Ecosystem Type:</span>
                <span class="badge primary">{{ project.ecosystem }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Project Area:</span>
                <strong>{{ project.area }} hectares</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Location:</span>
                <strong>{{ project.admin_area }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Start Date:</span>
                <strong>{{ project.start_date or 'Not specified' }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                <span style="color: #6b7280;">Submission Date:</span>
                <strong>{{ project.submission_date.strftime('%d %B %Y, %I:%M %p') }}</strong>
            </div>
        </div>
    </div>

    <!-- Tree Information -->
    <div class="card">
        <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
            <i class="fas fa-tree" style="color: #22c55e;"></i>
            Tree Information
        </h4>
        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Number of Trees:</span>
                <strong style="color: #059669; font-size: 18px;">{{ project.number_of_trees or 'Not specified' }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Tree Species:</span>
                <strong>{{ project.tree_species or project.species or 'Not specified' }}</strong>
            </div>
            {% if project.tree_height and project.tree_dbh %}
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Average Height:</span>
                <strong>{{ project.tree_height }} meters</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Average DBH:</span>
                <strong>{{ project.tree_dbh }} meters</strong>
            </div>
            {% if project.tree_age %}
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="color: #6b7280;">Average Age:</span>
                <strong>{{ project.tree_age }} years</strong>
            </div>
            {% endif %}
            {% endif %}
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                <span style="color: #6b7280;">Species List:</span>
                <div style="text-align: right;">
                    {% if project.species %}
                        {% for species in project.species.split(',') %}
                        <span class="badge outline" style="margin: 2px;">{{ species.strip() }}</span>
                        {% endfor %}
                    {% else %}
                        <span style="color: #9ca3af;">Not specified</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Carbon Credit Information -->
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-leaf" style="color: #10b981;"></i>
        Carbon Credit Analysis
    </h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #059669; font-size: 14px; margin-bottom: 8px;">CREDITS REQUESTED</div>
            <div style="font-size: 32px; font-weight: bold; color: #047857;">{{ project.credits_requested }}</div>
            <div style="color: #065f46; font-size: 14px;">tCO‚ÇÇe</div>
        </div>
        
        {% if project.status == 'Verified' %}
        <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #059669; font-size: 14px; margin-bottom: 8px;">CREDITS APPROVED</div>
            <div style="font-size: 32px; font-weight: bold; color: #047857;">{{ project.credits_approved }}</div>
            <div style="color: #065f46; font-size: 14px;">tCO‚ÇÇe</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #fef3c7, #fef08a); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #d97706; font-size: 14px; margin-bottom: 8px;">TOKEN ID</div>
            <div style="font-size: 16px; font-weight: bold; color: #b45309;">{{ project.token_id }}</div>
            <div style="color: #92400e; font-size: 12px;">Blockchain Verified</div>
        </div>
        {% endif %}
        
        {% if project.number_of_trees and project.credits_requested %}
        <div style="background: linear-gradient(135deg, #f0f9ff, #dbeafe); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="color: #2563eb; font-size: 14px; margin-bottom: 8px;">PER TREE AVERAGE</div>
            <div style="font-size: 24px; font-weight: bold; color: #1d4ed8;">
                {{ "%.3f"|format(project.credits_requested / project.number_of_trees) }}
            </div>
            <div style="color: #1e40af; font-size: 14px;">tCO‚ÇÇe/tree</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Project Description -->
{% if project.description %}
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-file-alt" style="color: #6b7280;"></i>
        Project Description
    </h4>
    <p style="line-height: 1.6; color: #374151;">{{ project.description }}</p>
</div>
{% endif %}

<!-- NEW: Location & GPS Coordinates Section -->
{% if project.location_coordinates or project.exact_location_data or project.location %}
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-map-marker-alt" style="color: #ef4444;"></i>
        Project Location & GPS Coordinates
        {% if project.real_time_data and project.real_time_data.coordinates_provided %}<span class="badge success" style="margin-left: 8px;">‚úì GPS Verified</span>{% endif %}
    </h4>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            {% if project.location_coordinates %}
            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 1px solid #3b82f6;">
                <h5 style="margin: 0 0 12px 0; color: #1e40af;">üìç Exact Coordinates</h5>
                <div style="display: grid; gap: 8px;">
                    <div><strong>Latitude:</strong> {{ "%.6f"|format(project.location_coordinates.latitude) if project.location_coordinates and project.location_coordinates.latitude else 'N/A' }}¬∞</div>
                    <div><strong>Longitude:</strong> {{ "%.6f"|format(project.location_coordinates.longitude) if project.location_coordinates and project.location_coordinates.longitude else 'N/A' }}¬∞</div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        <i class="fas fa-clock"></i> Recorded: {{ project.submission_date.strftime('%d %b %Y, %I:%M %p') }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if project.admin_area %}
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px;">
                <div style="color: #6b7280; font-size: 14px;">Administrative Area</div>
                <div style="font-weight: 600;">{{ project.admin_area }}</div>
            </div>
            {% endif %}
        </div>
        
        {% if project.location_coordinates and project.location_coordinates.latitude and project.location_coordinates.longitude %}
        <div>
            <div id="locationMap" style="height: 300px; border-radius: 8px; border: 1px solid #e5e7eb;"></div>
            <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #6b7280;">
                Interactive satellite map showing exact project location
            </div>
        </div>
        {% elif project.location %}
        <div>
            <div style="background: #f3f4f6; padding: 20px; text-align: center; border-radius: 8px; color: #6b7280;">
                <i class="fas fa-map-pin" style="font-size: 24px; margin-bottom: 8px;"></i>
                <div>Location: {{ project.location }}</div>
                <div style="font-size: 12px; margin-top: 4px;">No GPS coordinates available</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- NEW: Baseline Condition & Uploaded Files Section -->
<div class="card" style="margin-bottom: 20px;">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-upload" style="color: #f59e0b;"></i>
        Baseline Condition & Project Files
{% if project.real_time_data and project.real_time_data.files_uploaded %}<span class="badge success" style="margin-left: 8px;">{{ total_uploaded_files or 0 }} File(s)</span>{% endif %}
    </h4>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Baseline Condition File -->
        <div>
            <h5 style="margin: 0 0 12px 0; color: #d97706;">
                <i class="fas fa-file-alt"></i> Baseline Condition Upload
            </h5>
            {% if project.baseline_file %}
            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border: 1px solid #f59e0b;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="font-size: 24px;">üìÑ</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #92400e;">{{ project.baseline_file.original_name }}</div>
                        <div style="font-size: 12px; color: #78350f;">
                            Size: {{ "%.1f"|format(project.baseline_file.file_size / 1024) }} KB ‚Ä¢ 
                            Uploaded: {{ project.baseline_file.upload_date[:16].replace('T', ' at ') }}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <a href="/ngo/uploads/{{ project.id }}/baseline/{{ project.baseline_file.saved_name }}" 
                       class="btn outline" style="font-size: 12px;" target="_blank">
                        <i class="fas fa-eye"></i> View File
                    </a>
                    <a href="/ngo/uploads/{{ project.id }}/baseline/{{ project.baseline_file.saved_name }}" 
                       class="btn secondary" style="font-size: 12px;" download>
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
            {% else %}
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; text-align: center; color: #6b7280;">
                <i class="fas fa-file-slash" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                <div>No baseline condition file uploaded</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Plant Images -->
        <div>
            <h5 style="margin: 0 0 12px 0; color: #059669;">
                <i class="fas fa-images"></i> Plant Images ({{ project.uploaded_images|length if project.uploaded_images else 0 }})
            </h5>
            {% if project.uploaded_images and project.uploaded_images|length > 0 %}
            <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #22c55e;">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-bottom: 12px;">
                    {% for image in project.uploaded_images[:6] %}
                    <div style="position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; border: 2px solid #dcfce7; cursor: pointer;" 
                         onclick="viewImage('/ngo/uploads/{{ project.id }}/media/{{ image.saved_name }}', '{{ image.original_name }}')">
                        <img src="/ngo/uploads/{{ project.id }}/media/{{ image.saved_name }}" 
                             style="width: 100%; height: 100%; object-fit: cover;" 
                             alt="{{ image.original_name }}" 
                             title="{{ image.original_name }}">
                    </div>
                    {% endfor %}
                    {% if project.uploaded_images|length > 6 %}
                    <div style="aspect-ratio: 1; border-radius: 6px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 12px; text-align: center;">
                        +{{ project.uploaded_images|length - 6 }}<br>more
                    </div>
                    {% endif %}
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button onclick="viewAllImages()" class="btn outline" style="font-size: 12px;">
                        <i class="fas fa-expand"></i> View All ({{ project.uploaded_images|length }})
                    </button>
                    <button onclick="downloadAllImages()" class="btn secondary" style="font-size: 12px;">
                        <i class="fas fa-download"></i> Download All
                    </button>
                </div>
            </div>
            {% else %}
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; text-align: center; color: #6b7280;">
                <i class="fas fa-image" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                <div>No plant images uploaded</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- File Upload Summary -->
{% if total_uploaded_files > 0 %}
    <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
<div style="font-size: 14px; color: #374151;">
                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                <strong>Upload Summary:</strong> {{ total_uploaded_files }} total file(s) ‚Ä¢ 
                Submission: {{ project.submission_timestamp[:16].replace('T', ' at ') if project.submission_timestamp else project.submission_date.strftime('%Y-%m-%d at %H:%M') if project.submission_date else 'N/A' }}
            </div>
            <div style="font-size: 12px; color: #6b7280;">
                Real-time data available ‚úì
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Contact Information -->
<div class="card">
    <h4 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        <i class="fas fa-address-book" style="color: #8b5cf6;"></i>
        Contact Information
    </h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <div style="color: #6b7280; font-size: 14px;">Contact Person</div>
            <div style="font-weight: 600;">{{ project.contact_person }}</div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 14px;">Email</div>
            <div><a href="mailto:{{ project.email }}">{{ project.email }}</a></div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 14px;">Phone</div>
            <div><a href="tel:{{ project.phone }}">{{ project.phone }}</a></div>
        </div>
        <div>
            <div style="color: #6b7280; font-size: 14px;">NGO ID</div>
            <div><code>{{ project.ngo_id }}</code></div>
        </div>
    </div>
</div>

<!-- Action Modal (same as projects.html) -->
<div id="actionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Project Action</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="actionForm">
                <input type="hidden" id="projectId" name="project_id" value="{{ project.id }}">
                <input type="hidden" id="actionType" name="action">
                
                <div class="form-group">
                    <label for="reason" id="reasonLabel">Reason:</label>
                    <textarea id="reason" name="reason" rows="4" class="form-control" placeholder="Enter reason for this action..."></textarea>
                </div>
                
                <!-- Credits approval section -->
                <div id="creditsSection" style="display: none;">
                    <div class="form-group">
                        <label for="approvedCredits">Credits to Approve:</label>
                        <input type="number" id="approvedCredits" name="approved_credits" 
                               value="{{ project.credits_requested }}" 
                               max="{{ project.credits_requested }}" min="0" step="0.001" 
                               class="form-control">
                        <small style="color: #6b7280;">Maximum: {{ project.credits_requested }} tCO‚ÇÇe (requested)</small>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" onclick="closeModal()" class="btn secondary">Cancel</button>
                    <button type="submit" class="btn primary" id="confirmBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function approveProject(projectId) {
    showActionModal(projectId, 'approve', 'Approve Project', 'Add any approval notes (optional):', 'Approve & Issue Credits');
    document.getElementById('creditsSection').style.display = 'block';
}

function rejectProject(projectId) {
    showActionModal(projectId, 'reject', 'Reject Project', 'Reason for rejection (required):', 'Reject Project');
}

function sendBackProject(projectId) {
    showActionModal(projectId, 'send_back', 'Send Back for Revision', 'What needs to be revised (required):', 'Send Back');
}

function showActionModal(projectId, action, title, reasonLabel, confirmText) {
    document.getElementById('projectId').value = projectId;
    document.getElementById('actionType').value = action;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('reasonLabel').textContent = reasonLabel;
    document.getElementById('confirmBtn').textContent = confirmText;
    document.getElementById('reason').required = action !== 'approve';
    document.getElementById('actionModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('actionModal').style.display = 'none';
    document.getElementById('actionForm').reset();
    document.getElementById('creditsSection').style.display = 'none';
}

function downloadReport(projectId) {
    window.open(`/admin/projects/${projectId}/report`, '_blank');
}

// Handle form submission
document.getElementById('actionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const projectId = formData.get('project_id');
    
    fetch(`/admin/projects/${projectId}/action`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.message, 'error');
        }
        closeModal();
    })
    .catch(error => {
        showNotification('An error occurred. Please try again.', 'error');
        closeModal();
    });
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('actionModal');
    if (event.target === modal) {
        closeModal();
    }
}

// NEW: Location Map Functionality
{% if project.location_coordinates and project.location_coordinates.latitude and project.location_coordinates.longitude %}
function initializeLocationMap() {
    const lat = {{ project.location_coordinates.latitude }};
    const lng = {{ project.location_coordinates.longitude }};
    
    // Initialize map with satellite view
    const map = L.map('locationMap').setView([lat, lng], 15);
    
    // Add satellite imagery
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);
    
    // Add marker at project location
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(`
        <div style="text-align: center; min-width: 200px;">
            <h4 style="margin: 0 0 8px 0; color: #1f2937;">{{ project.name }}</h4>
            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                <strong>NGO:</strong> {{ project.ngo_name }}<br>
                <strong>Coordinates:</strong><br>
                {{ "%.6f"|format(project.location_coordinates.latitude) }}¬∞, {{ "%.6f"|format(project.location_coordinates.longitude) }}¬∞
            </div>
            <div style="font-size: 12px; color: #9ca3af;">
                Submitted: {{ project.submission_date.strftime('%d %B %Y') }}
            </div>
        </div>
    `).openPopup();
    
    // Add project area circle if area data exists
    {% if project.area %}
    const areaRadius = Math.sqrt({{ project.area }} * 10000 / Math.PI); // Convert hectares to meters radius
    L.circle([lat, lng], {
        color: '#22c55e',
        fillColor: '#22c55e',
        fillOpacity: 0.1,
        radius: areaRadius
    }).addTo(map).bindTooltip(`Project Area: {{ project.area }} hectares`);
    {% endif %}
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load Leaflet CSS and JS if not already loaded
    if (!window.L) {
        const leafletCSS = document.createElement('link');
        leafletCSS.rel = 'stylesheet';
        leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(leafletCSS);
        
        const leafletJS = document.createElement('script');
        leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        leafletJS.onload = function() {
            setTimeout(initializeLocationMap, 100);
        };
        document.head.appendChild(leafletJS);
    } else {
        initializeLocationMap();
    }
});
{% endif %}

// Image viewing functions
function viewImage(imageSrc, imageName) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; cursor: pointer;
    `;
    
    const img = document.createElement('img');
    img.src = imageSrc;
    img.alt = imageName;
    img.style.cssText = `
        max-width: 90%; max-height: 90%; border-radius: 8px; 
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    `;
    
    const caption = document.createElement('div');
    caption.textContent = imageName;
    caption.style.cssText = `
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        color: white; background: rgba(0,0,0,0.7); padding: 8px 16px; 
        border-radius: 20px; font-size: 14px;
    `;
    
    modal.appendChild(img);
    modal.appendChild(caption);
    document.body.appendChild(modal);
    
    modal.onclick = function() {
        document.body.removeChild(modal);
    };
}

function viewAllImages() {
    const images = {{ project.uploaded_images|tojson if project.uploaded_images else '[]' }};
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto; padding: 20px;
    `;
    
    const header = document.createElement('div');
    header.innerHTML = `
        <div style="text-align: center; color: white; margin-bottom: 20px;">
            <h3 style="margin: 0;">All Plant Images (${images.length})</h3>
            <p style="margin: 8px 0; opacity: 0.8;">{{ project.name }} - {{ project.ngo_name }}</p>
            <button onclick="this.closest('.modal-overlay').remove()" 
                    style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 8px;">
                Close Gallery
            </button>
        </div>
    `;
    
    const gallery = document.createElement('div');
    gallery.style.cssText = `
        display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 20px; max-width: 1200px; margin: 0 auto;
    `;
    
    images.forEach(image => {
        const imageContainer = document.createElement('div');
        imageContainer.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 12px; cursor: pointer;"
                 onclick="viewImage('/ngo/uploads/{{ project.id }}/media/${image.saved_name}', '${image.original_name}')">
                <img src="/ngo/uploads/{{ project.id }}/media/${image.saved_name}" 
                     style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" 
                     alt="${image.original_name}">
                <div style="font-size: 14px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">${image.original_name}</div>
                <div style="font-size: 12px; color: #6b7280;">
                    ${(image.file_size / 1024).toFixed(1)} KB ‚Ä¢ ${image.upload_date.substring(0, 16).replace('T', ' at ')}
                </div>
            </div>
        `;
        gallery.appendChild(imageContainer);
    });
    
    modal.className = 'modal-overlay';
    modal.appendChild(header);
    modal.appendChild(gallery);
    document.body.appendChild(modal);
}

function downloadAllImages() {
    const images = {{ project.uploaded_images|tojson if project.uploaded_images else '[]' }};
    
    if (images.length === 0) {
        alert('No images to download');
        return;
    }
    
    images.forEach((image, index) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = `/ngo/uploads/{{ project.id }}/media/${image.saved_name}`;
            link.download = image.original_name;
            link.click();
        }, index * 500); // Stagger downloads
    });
    
    showNotification(`Downloading ${images.length} plant images...`, 'success');
}
</script>

<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    max-width: 400px;
}

.notification.success {
    background: #22c55e;
}

.notification.error {
    background: #ef4444;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
    margin: 0;
    color: #1f2937;
}

.close {
    color: #9ca3af;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #374151;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}
</style>
{% endblock %}