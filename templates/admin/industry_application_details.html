{% extends "admin_base.html" %}
{% set active = 'industries' %}
{% set header = 'Industry Application Details' %}

{% block content %}
<div class="card" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-building" style="color: var(--primary);"></i>
            {{ application.company_name or application.name or 'Company Application' }}
        </h2>
        <div style="display: flex; align-items: center; gap: 12px;">
            {% if application.status == 'Verified' %}
                <span class="badge success">
                    <i class="fas fa-check-circle"></i> Verified
                </span>
            {% elif application.status == 'Pending' %}
                <span class="badge warning">
                    <i class="fas fa-clock"></i> Pending Review
                </span>
            {% elif application.status == 'Under Review' %}
                <span class="badge info">
                    <i class="fas fa-search"></i> Under Review
                </span>
            {% elif application.status == 'Blacklisted' %}
                <span class="badge danger">
                    <i class="fas fa-times-circle"></i> Rejected
                </span>
            {% else %}
                <span class="badge secondary">{{ application.status }}</span>
            {% endif %}
            
            {% if application.status == 'Pending' %}
            <div style="display: flex; gap: 8px;">
                <button onclick="showApprovalModal()" class="btn success">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button onclick="showRejectionModal()" class="btn danger">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button onclick="showInfoRequestModal()" class="btn secondary">
                    <i class="fas fa-question-circle"></i> Request Info
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div>
            <div class="stat-label">Application ID</div>
            <div class="stat-value" style="font-size: 18px;">{{ application.id }}</div>
        </div>
        <div>
            <div class="stat-label">Industry Type</div>
            <div class="stat-value" style="font-size: 16px;">{{ (application.industry_type or application.sector or 'N/A')|title }}</div>
        </div>
        <div>
            <div class="stat-label">Company Size</div>
            <div class="stat-value" style="font-size: 16px;">{{ (application.company_size or 'N/A')|title }}</div>
        </div>
        {% if application.annual_emissions %}
        <div>
            <div class="stat-label">Annual Emissions</div>
            <div class="stat-value" style="font-size: 16px;">{{ application.annual_emissions|round|int }} tCO2e</div>
        </div>
        {% endif %}
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
    <div class="card">
        <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-building" style="color: var(--primary);"></i>
            Company Information
        </h3>
        
        <div style="display: grid; gap: 15px;">
            <div>
                <strong>Company Name:</strong> {{ application.company_name or application.name or 'Not specified' }}
            </div>
            {% if application.trading_name %}
            <div>
                <strong>Trading Name:</strong> {{ application.trading_name }}
            </div>
            {% endif %}
            {% if application.registration_number %}
            <div>
                <strong>Registration Number:</strong> {{ application.registration_number }}
            </div>
            {% endif %}
            <div>
                <strong>Industry Type:</strong> {{ (application.industry_type or application.sector or 'Not specified')|title }}
            </div>
            {% if application.company_size %}
            <div>
                <strong>Company Size:</strong> {{ application.company_size|title }}
            </div>
            {% endif %}
            {% if application.annual_emissions %}
            <div>
                <strong>Annual Emissions:</strong> {{ application.annual_emissions|round|int }} tCO2e/year
            </div>
            {% endif %}
            {% if application.website %}
            <div>
                <strong>Website:</strong> <a href="{{ application.website }}" target="_blank">{{ application.website }}</a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card">
        <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user" style="color: var(--secondary);"></i>
            Contact Information
        </h3>
        
        <div style="display: grid; gap: 15px;">
            <div>
                <strong>Contact Person:</strong> {{ application.contact_person or application.signatory_name or 'Not specified' }}
            </div>
            {% if application.designation %}
            <div>
                <strong>Designation:</strong> {{ application.designation }}
            </div>
            {% endif %}
            <div>
                <strong>Email:</strong> 
                <a href="mailto:{{ application.email or application.primary_email }}">
                    {{ application.email or application.primary_email or 'Not specified' }}
                </a>
            </div>
            {% if application.phone or application.primary_phone %}
            <div>
                <strong>Phone:</strong> {{ application.phone or application.primary_phone }}
            </div>
            {% endif %}
            {% if application.secondary_phone %}
            <div>
                <strong>Secondary Phone:</strong> {{ application.secondary_phone }}
            </div>
            {% endif %}
            {% if application.address %}
            <div>
                <strong>Address:</strong> {{ application.address }}
            </div>
            {% endif %}
            {% if application.city or application.state %}
            <div>
                <strong>Location:</strong> 
                {{ application.city }}{% if application.city and application.state %}, {% endif %}{{ application.state }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if application.bank_name or application.account_number or application.wallet_address %}
<div class="card" style="margin-bottom: 24px;">
    <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-university" style="color: var(--success);"></i>
        Financial Information
    </h3>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        {% if application.bank_name %}
        <div>
            <strong>Bank Name:</strong> {{ application.bank_name }}
        </div>
        {% endif %}
        {% if application.account_number %}
        <div>
            <strong>Account Number:</strong> {{ application.account_number }}
        </div>
        {% endif %}
        {% if application.ifsc_code %}
        <div>
            <strong>IFSC Code:</strong> {{ application.ifsc_code }}
        </div>
        {% endif %}
        {% if application.wallet_address %}
        <div style="grid-column: 1 / -1;">
            <strong>Wallet Address:</strong>
            <code style="word-break: break-all; font-size: 12px; background: #f3f4f6; padding: 4px 6px; border-radius: 4px; display: block; margin-top: 4px;">
                {{ application.wallet_address }}
            </code>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
    <div class="card">
        <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-calendar" style="color: var(--info);"></i>
            Application Timeline
        </h3>
        
        <div style="display: grid; gap: 15px;">
            {% if application.application_date or application.registration_date %}
            <div>
                <strong>Application Date:</strong>
                {% if application.application_date %}
                    {{ application.application_date.strftime('%d %B %Y, %I:%M %p') }}
                {% elif application.registration_date %}
                    {{ application.registration_date.strftime('%d %B %Y, %I:%M %p') }}
                {% endif %}
            </div>
            {% endif %}
            {% if application.verification_date %}
            <div>
                <strong>Verification Date:</strong> {{ application.verification_date.strftime('%d %B %Y, %I:%M %p') }}
            </div>
            {% endif %}
            {% if application.approval_date %}
            <div>
                <strong>Approval Date:</strong> {{ application.approval_date.strftime('%d %B %Y, %I:%M %p') }}
            </div>
            {% endif %}
            {% if application.rejection_date %}
            <div>
                <strong>Rejection Date:</strong> {{ application.rejection_date.strftime('%d %B %Y, %I:%M %p') }}
            </div>
            {% endif %}
            {% if application.info_requested_date %}
            <div>
                <strong>Info Requested:</strong> {{ application.info_requested_date.strftime('%d %B %Y, %I:%M %p') }}
            </div>
            {% endif %}
            {% if application.last_updated %}
            <div>
                <strong>Last Updated:</strong> {{ application.last_updated.strftime('%d %B %Y, %I:%M %p') }}
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if application.verification_notes or application.rejection_reason %}
    <div class="card">
        <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-sticky-note" style="color: var(--warning);"></i>
            Admin Notes
        </h3>
        
        <div style="display: grid; gap: 15px;">
            {% if application.verification_notes %}
            <div>
                <strong>Verification Notes:</strong>
                <p style="margin: 8px 0 0 0; padding: 10px; background: #f9fafb; border-radius: 6px; border-left: 4px solid var(--primary);">
                    {{ application.verification_notes }}
                </p>
            </div>
            {% endif %}
            {% if application.rejection_reason %}
            <div>
                <strong>Rejection Reason:</strong>
                <p style="margin: 8px 0 0 0; padding: 10px; background: #fef2f2; border-radius: 6px; border-left: 4px solid var(--danger);">
                    {{ application.rejection_reason }}
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% if application.admin_notes_history %}
<div class="card" style="margin-bottom: 24px;">
    <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-history" style="color: var(--secondary);"></i>
        Admin Notes History
    </h3>
    
    <div style="display: grid; gap: 12px;">
        {% for note in application.admin_notes_history %}
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 4px solid var(--primary);">
            <div style="font-weight: 500; margin-bottom: 4px;">{{ note.admin_name }}</div>
            <div style="color: #6b7280; font-size: 12px; margin-bottom: 8px;">
                {{ note.timestamp.strftime('%d %B %Y, %I:%M %p') }}
            </div>
            <div>{{ note.note }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div style="text-align: center; margin-top: 32px;">
    <a href="{{ url_for('admin.industry_applications') }}" class="btn outline">
        <i class="fas fa-arrow-left"></i> Back to Applications
    </a>
</div>

<!-- Action Modals -->
<div id="approvalModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Approve Application</h3>
            <span class="close" onclick="closeModal('approvalModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="approvalForm">
                <div class="form-group">
                    <label for="approveReason">Approval Notes</label>
                    <textarea id="approveReason" name="reason" placeholder="Add any notes about the approval..."></textarea>
                </div>
                <div class="form-group">
                    <label for="approveAdminNotes">Internal Admin Notes (Optional)</label>
                    <textarea id="approveAdminNotes" name="admin_notes" placeholder="Internal notes for admin reference..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn outline" onclick="closeModal('approvalModal')">Cancel</button>
            <button type="button" class="btn success" onclick="submitAction('approve')">
                <i class="fas fa-check"></i> Approve Application
            </button>
        </div>
    </div>
</div>

<div id="rejectionModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reject Application</h3>
            <span class="close" onclick="closeModal('rejectionModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="rejectionForm">
                <div class="form-group">
                    <label for="rejectReason">Rejection Reason *</label>
                    <textarea id="rejectReason" name="reason" placeholder="Please provide a detailed reason for rejection..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="rejectAdminNotes">Internal Admin Notes (Optional)</label>
                    <textarea id="rejectAdminNotes" name="admin_notes" placeholder="Internal notes for admin reference..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn outline" onclick="closeModal('rejectionModal')">Cancel</button>
            <button type="button" class="btn danger" onclick="submitAction('reject')">
                <i class="fas fa-times"></i> Reject Application
            </button>
        </div>
    </div>
</div>

<div id="infoRequestModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Request Additional Information</h3>
            <span class="close" onclick="closeModal('infoRequestModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="infoRequestForm">
                <div class="form-group">
                    <label for="infoReason">Information Requested *</label>
                    <textarea id="infoReason" name="reason" placeholder="Specify what additional information is needed..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="infoAdminNotes">Internal Admin Notes (Optional)</label>
                    <textarea id="infoAdminNotes" name="admin_notes" placeholder="Internal notes for admin reference..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn outline" onclick="closeModal('infoRequestModal')">Cancel</button>
            <button type="button" class="btn secondary" onclick="submitAction('request_info')">
                <i class="fas fa-question-circle"></i> Request Information
            </button>
        </div>
    </div>
</div>

<script>
function showApprovalModal() {
    document.getElementById('approvalModal').style.display = 'block';
}

function showRejectionModal() {
    document.getElementById('rejectionModal').style.display = 'block';
}

function showInfoRequestModal() {
    document.getElementById('infoRequestModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function submitAction(action) {
    let form, modal;
    
    if (action === 'approve') {
        form = document.getElementById('approvalForm');
        modal = 'approvalModal';
    } else if (action === 'reject') {
        form = document.getElementById('rejectionForm');
        modal = 'rejectionModal';
    } else if (action === 'request_info') {
        form = document.getElementById('infoRequestForm');
        modal = 'infoRequestModal';
    }
    
    const formData = new FormData(form);
    formData.append('action', action);
    
    fetch(`{{ url_for('admin.industry_application_action', app_id=application.id) }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing the request.');
    });
    
    closeModal(modal);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = ['approvalModal', 'rejectionModal', 'infoRequestModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            closeModal(modalId);
        }
    });
}
</script>
{% endblock %}